<!DOCTYPE HTML>
<html>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">

<!--JS-->
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="Chart.min.js"></script>

<!--CSS-->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="style.css">

<script>

$(function() {

var vars = {};
var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
  vars[key] = value;
});

if (('name' in vars) && ('network' in vars)) {
  $('#login').hide();
  $('#username').html(unescape(vars.name));
  console.log('hide login');
}
else {
  $('#main').hide();
  console.log('hide main');
}

$('#add_question').submit(function(e) {
  var question = $('#question_in').val();
  var option1 = $('#option1_in').val();
  var option2 = $('#option2_in').val();
  var isPublic = $('#public_in').val();

  $.ajax({
    type: 'GET',
    url: '/postpoll',
    data: {
      question: question,
      option1: option1,
      option2: option2,
      group: isPublic,
      user: unescape(vars.name)
    }
  })
  .done(function(res) {
    location.reload();
  });

  e.preventDefault();
});

var last_id = null;

var getNewQuestion = function() {
  $.ajax({
    type: 'GET',
    url: '/getpoll',
    data: {user_id: unescape(vars.name)}
  })
  .done(function(res) {
    console.log(res);
    if(!res){
      return;
      }
    last_id = res._id;
    $('#question_out').html(res.question);
    if (/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(res.option1)){
      $('#option1_out').html("<img src = '" + res.option1  + "'></img>");
    } else {
      $('#option1_out').html(res.option1);
    }
    if (/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(res.option1)){
      $('#option2_out').html("<img src = '" + res.option2 + "'></img>");
    } else {
      $('#option2_out').html(res.option2);
    }
  });
};
getNewQuestion();

var getUserPolls = function() {
  $.ajax({
    type: 'GET',
    url: '/userpolls',
    data: {user_id: unescape(vars.name)}
  })
  .done(function(res) {
    if(!res){
      return;
    }
    res.forEach(function(poll) {
      var s = '<div>';
      s += '<canvas id="_' + poll._id + '" width="400" height="400"></canvas>';
      s += '</div>';
      $('#results').append(s);

      var data = {
        labels: [poll.option1, poll.option2],
        datasets: [
            {
                label: "My First dataset",
                fillColor: "rgba(220,220,220,0.5)",
                strokeColor: "rgba(220,220,220,0.8)",
                highlightFill: "rgba(220,220,220,0.75)",
                highlightStroke: "rgba(220,220,220,1)",
                data: [poll.votes1, poll.voted2]
            }
        ]
      };
      var ctx = $("#_" + poll._id).get(0).getContext("2d");
      var myBarChart = new Chart(ctx).Bar(data/*, options*/);
    });

  });
};
getUserPolls();

$('#option1_out').click(function() {
  console.log('cast');
  $.ajax({
    type: 'GET',
    url: '/castvote',
    data: {
      id: last_id,
      option1: true
    }
  });
  getNewQuestion();
});
$('#option2_out').click(function() {
  $.ajax({
    type: 'GET',
    url: '/castvote',
    data: {
      id: last_id,
      option2: true
    }
  });
  getNewQuestion();
});

});

</script>

</head>

<body class="claro">

<div id="login">
  <a href = "https://www.yammer.com/dialog/oauth?client_id=duMqFN8SOor3eIF7to3sg&redirect_uri=http://localhost:3333/redirect">Login</a>

</div>

<div id="main">
<p>Welcome</p> <p id = "username"></p>

<form id="add_question">
  Question: <input type="text" id="question_in"><br>

  Option 1: <input type="text" width="50%" id="option1_in"><br>
  Option 2: <input type="text" width="50%" id="option2_in"><br>

  <input type="checkbox" id="public_in">public</input>

  <input type="submit">

</form>

<div class="row2">
  <div id="question_out"></div><br>
  <div id="option1_out" width="50%" height="200px"></div>
  <div id="option2_out" width="50%" height="200px"></div>

</div>

</div>

<hr>

<div id="results">

</div>

</body>

</html>
